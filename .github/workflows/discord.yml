name: Notify Discord

on:
  push:
    branches:
      - main

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send message to Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          payload=$(cat <<'EOF'
          {
            "username": "GitHub Actions",
            "content": "ðŸš€ Nouveau push sur `${{ github.repository }}` (branche `${{ github.ref_name }}`)",
            "embeds": [
              {
                "title": "Commit ${GITHUB_SHA:0:7}",
                "url": "https://github.com/${{ github.repository }}/commit/${{ github.sha }}",
                "description": "${{ github.event.head_commit.message || 'Pas de message' }}",
                "fields": [
                  { "name": "Auteur", "value": "${{ github.actor }}", "inline": true },
                  { "name": "Auteur (git)", "value": "${{ github.event.head_commit.author.name || github.actor }}", "inline": true },
                  { "name": "Email", "value": "${{ github.event.head_commit.author.email || 'n/a' }}", "inline": true },
                  { "name": "Ã‰vÃ©nement", "value": "${{ github.event_name }}", "inline": true },
                  { "name": "Workflow", "value": "${{ github.workflow }}", "inline": true },
                  { "name": "Job", "value": "${{ github.job }}", "inline": true },
                  { "name": "Repo", "value": "${{ github.repository }}", "inline": true }
                ],
                "timestamp": "${{ github.event.head_commit.timestamp || '' }}"
              }
            ]
          }
          EOF
          )
          curl -H "Content-Type: application/json" \
               -X POST \
               -d "$payload" \
               "$DISCORD_WEBHOOK"